image: node:14-slim

definitions:
  caches:
    npm: $HOME/.npm

stepdefinitions:
  - tests: &tests
      name: Run tests and quality gate
      script:
        - npm ci --prefer-offline --no-audit
        - npm run test
        - npm run prettier
        - npm run lint
  - publish-npm: &publish-npm
      name: Build and publish npm package
      caches:
        - npm
      script:
        - npm ci --prefer-offline --no-audit
        - npm run build
        - pipe: atlassian/npm-publish:0.2.0
          variables:
            EXTRA_ARGS: "--access public"
            NPM_TOKEN: $NPM_TOKEN
  - publish-s3: &publish-s3
      name: Build and publish bundle to s3
      caches:
        - npm
      script:
        - npm ci --prefer-offline --no-audit
        - npm run build
        - pipe: atlassian/aws-s3-deploy:0.4.5
          variables:
            AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
            AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
            AWS_DEFAULT_REGION: "eu-west-1"
            S3_BUCKET: "theoplayer-cdn/connectors"
            LOCAL_PATH: "dist/bundle"

pipelines:
  default:
    - step: *tests
  tags:
    v*:
      - step: *tests
      - parallel:
          - step: *publish-npm
          - step: *publish-s3
